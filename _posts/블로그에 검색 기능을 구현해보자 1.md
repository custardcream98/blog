---
title: "ë¸”ë¡œê·¸ì— ê²€ìƒ‰ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì 1"
excerpt: "ì ì  í¬ìŠ¤íŠ¸ ìˆ˜ê°€ ë§ì•„ì ¸ì„œ ë¿Œë“¯í•˜ê¸´ í•œë°, ê°€ë” ì œê°€ ì“´ ê¸€ì„ ì°¾ê¸°ê°€ ì–´ë µë”ë¼ê³ ìš”. ê·¸ë˜ì„œ ì´ë²ˆì—” ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì§ì ‘ êµ¬í˜„í•´ë³´ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤."
date: "2022-11-26T04:09:00+09:00"
category: ["React.js", "Next.js"]
---

> ì ì  í¬ìŠ¤íŠ¸ ìˆ˜ê°€ ë§ì•„ì ¸ì„œ ë¿Œë“¯í•˜ê¸´ í•œë°, ê°€ë” ì œê°€ ì“´ ê¸€ì„ ì°¾ê¸°ê°€ ì–´ë µë”ë¼ê³ ìš”. ê·¸ë˜ì„œ ì´ë²ˆì—” ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì§ì ‘ êµ¬í˜„í•´ë³´ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

# ì–´ë–»ê²Œ ê°œë°œí• ê¹Œ

- husky pre-commit hookìœ¼ë¡œ ì»¤ë°‹í•  ë•Œ ìë™ìœ¼ë¡œ ìºì‹œë¥¼ ìƒì„±
- Next.jsì— ê²€ìƒ‰ìš© API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ (Fuzzy ê²€ìƒ‰ ê°„ë‹¨í•˜ê²Œ ì ìš©í•´ë³´ê¸°)
- ê²€ìƒ‰ë°” êµ¬í˜„ (ë””ë°”ìš´ì‹±ê³¼ ì“°ë¡œí‹€ë§ ë¹„êµí•´ë³´ê¸°)

ê°€ì¥ ì¢‹ì€ ë°©ë²•ì€ ì•„ë‹ìˆœ ìˆì–´ë„ ìš°ì„  ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê³ , ì¶”í›„ ì¡°ê¸ˆì”© ìµœì í™”í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

## ìºì‹œë¥¼ ìƒì„±í•˜ì!

ì œ ë¸”ë¡œê·¸ëŠ” ì•„ë˜ì˜ ìˆœì„œë¡œ í¬ìŠ¤íŠ¸ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.

1. ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì„ ì½ì–´ì˜µë‹ˆë‹¤.
2. ì½ì–´ì˜¨ ë‚´ìš©ì„ HTMLë¡œ íŒŒì‹±í•©ë‹ˆë‹¤. (`remark`ë¥¼ í™œìš©í•©ë‹ˆë‹¤) ì´ ë•Œ, íŒŒì‹±ì˜ ê²°ê³¼ëŠ” `string`ì…ë‹ˆë‹¤.
3. íŒŒì‹±í•œ ë‚´ìš©ì„ ë§ˆí¬ë‹¤ìš´ìš© ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ styled-componentì— `dangerouslySetInnerHTML`ë¡œ ë„£ìŠµë‹ˆë‹¤.

ê²€ìƒ‰ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë ¤ë©´ ëª¨ë“  í¬ìŠ¤íŠ¸ì— ëŒ€í•œ ë‚´ìš©ì„ ê°€ì§€ê³  ìˆëŠ” ì¼ì¢…ì˜ ìºì‹œê°€ í•„ìš”í•©ë‹ˆë‹¤.

ì €ëŠ” ì´ ìºì‹œë¥¼ ë§¤ ì»¤ë°‹ ì§ì „ì— ìë™ìœ¼ë¡œ ìƒì„±í•˜ê³ ì í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ì•„ë˜ì˜ íŒŒì¼ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.

```typescript
// cache/cache.ts

import fs from "fs";
import { JSDOM } from "jsdom";

import { markdownToHtmlForCache } from "../lib/utils/markdownToHtml";
import { getAllPosts } from "../lib/utils/posts";
import { CachePost } from "./type";

const postsData = getAllPosts(["slug", "title", "content"]);

(async () => {
  const postsCache: CachePost[] = await Promise.all(
    postsData.map(async ({ slug, title, content }) => {
      const cacheHTML = await markdownToHtmlForCache(
        content
      );
      const { document } = new JSDOM(cacheHTML).window;
      const elements = document.querySelectorAll(
        "h1, h2, h3, h4, h5, h6, p, ol, ul"
      );

      let extractedContent = "";

      elements.forEach(
        (ele) => (extractedContent += ele.textContent)
      );

      return {
        slug,
        title,
        content: extractedContent,
      };
    })
  );

  fs.writeFile(
    `./cache/cache.json`,
    JSON.stringify(postsCache),
    (error) => {
      if (error) {
        console.error(error);
      }
      console.log("ìºì‹œ ìƒì„± ì™„ë£Œ");
    }
  );
})();
```

ìš°ì„  íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ì™€ì•¼ í•©ë‹ˆë‹¤. ì €ëŠ” ì´ë¯¸ ë§ˆí¬ë‹¤ìš´ì„ ì½ê³  HTMLë¡œ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ ì“°ê³  ìˆì—ˆìœ¼ë¯€ë¡œ, í•´ë‹¹ í•¨ìˆ˜ë“¤ì„ í™œìš©í•´ HTMLë¡œ íŒŒì‹±ëœ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

ê·¸ë ‡ê²Œ íŒŒì‹±ëœ HTML `string`ì€ 18ë²ˆì§¸ ì¤„ì—ì„œ Document Objectë¡œ íŒŒì‹±ë©ë‹ˆë‹¤. ë…¸ë“œ í™˜ê²½ì—ì„œ DOM APIë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `jsdom` ëª¨ë“ˆì„ í™œìš©í–ˆìŠµë‹ˆë‹¤.

ê·¸ í›„, í•„ìš”í•œ ìš”ì†Œë¥¼ `querySelectorAll()`ë¡œ ê°€ì ¸ì˜¤ê³ , ê° ìš”ì†Œë¥¼ ëŒë©° `textContent`ë¥¼ ì¶”ì¶œí•´ `postsCache`ì— ë‹´ìŠµë‹ˆë‹¤.

15ë²ˆì§¸ ì¤„ì— ë³´ì‹œë©´ ë§ˆí¬ë‹¤ìš´ `string`ìœ¼ë¡œë¶€í„° HTML `string`ì„ ìƒì„±í•˜ëŠ” `markdownToHtmlForCache()`ê°€ ë¹„ë™ê¸° í•¨ìˆ˜ì´ë¯€ë¡œ `postsData.map()`ì„ `Promise.all()`ë¡œ ê°ì‹¸ì¤ë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ `postsCache`ë¥¼ `cache.json`ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ ë‹¤ìŒ ê°œë°œí•  APIì—ì„œ ì´ json íŒŒì¼ì„ ìºì‹œë¡œ ì‚¬ìš©í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

> Top-level awaitë¥¼ ì¼ìœ¼ë©´ ë” ë³´ê¸° ì¢‹ì•˜ê² ì§€ë§Œ Next.jsì™€ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë™ì‘í•  ë¶€ë¶„ ë•Œë¬¸ì— ì „ì²´ í”„ë¡œì íŠ¸ì˜ ì„¤ì •ì„ ë°”ê¾¸ê³  ì‹¶ì§€ëŠ” ì•Šì•„ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

ì´ì œ ì´ `cache.ts`ë¥¼ ì‹¤í–‰í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ pre-commit í›…ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

```json
// package.json
{
  "scripts": {
    "cache": "tsx ./cache/cache.ts"
  }
}
```

`cache.ts` ì‹¤í–‰ì„ ìœ„í•´ `tsx`ë¥¼ `devDependency`ë¡œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

```shell
# husky pre-commit hook
# ./husky/pre-commit

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npm run cache && git add ./cache/cache.json
```

## ê²€ìƒ‰ìš© ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ì

ìš°ì„ , ê²€ìƒ‰ìš© APIë¥¼ ê°œë°œí•˜ê¸° ì•ì„œì„œ í•œê°€ì§€ ìƒê°í•´ë³¼ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.

<figure>
  <img src="/static/img/ë¸”ë¡œê·¸ì—_ê²€ìƒ‰_ê¸°ëŠ¥ì„_êµ¬í˜„í•´ë³´ì/ìë™ì™„ì„±.gif" alt="ë„¤ì´ë²„ ìë™ì™„ì„±" />
  <figcaption>ë„¤ì´ë²„ì˜ ìë™ì™„ì„±</figcaption>
</figure>

ë§ì€ ì„œë¹„ìŠ¤ë“¤ì´ ê²€ìƒ‰ì‹œ 'ëŒ€ì¶© ì…ë ¥í•´ë„ ì›í•˜ëŠ”ê±¸ ì°¾ì•„ ë³´ì—¬ì£¼ëŠ”' ìë™ì™„ì„± ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì €ëŠ” ì´ê²ƒì²˜ëŸ¼ ì‚¬ìš©ìì˜ ì…ë ¥ê°’ì´ ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ì°¾ê³ ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê¸€ì„ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥ì„ ë¶™ì´ê³  ì‹¶ìŠµë‹ˆë‹¤.

### Fuzzy ê°„ë‹¨í•˜ê²Œ ì ìš©í•´ë³´ê¸°

[ì°¸ê³ í•œ íƒœê³¤ë‹˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸](https://taegon.kim/archives/9919)

Fuzzy ì•Œê³ ë¦¬ì¦˜ì€ ì´ë¥¼ êµ¬í˜„í•  ë•Œ ì“¸ ìˆ˜ ìˆëŠ” ë°©ë²•ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ë‘ ë¬¸ìì—´ì˜ ìœ ì‚¬ì„±ì„ íŒŒì•…í•´ì„œ ìœ ì‚¬ë„ê°€ ë†’ì€ì§€ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ëŠ” ì‹ì…ë‹ˆë‹¤.

ê´€ë ¨í•´ì„œ ë³µì¡í•œ ì•Œê³ ë¦¬ì¦˜ ì´ë¡ ë“¤ì´ ë§ì´ ë‚˜ì™€ìˆì§€ë§Œ ì €ëŠ” ìµœëŒ€í•œ ê°„ë‹¨í•˜ê²Œ ì ‘ê·¼í•˜ë©´ì„œ ì œê°€ ì§ì ‘ ë°”ê¿€ ìˆ˜ ìˆë„ë¡ íƒœê³¤ë‹˜ ë¸”ë¡œê·¸ì— ë‚˜ì˜¨ ë°©ë²•ì„ ì ìš©, ì¼ë¶€ ì½”ë“œë¥¼ ì¡°ê¸ˆ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. (ëŒ€ì†Œë¬¸ì ë‘˜ ë‹¤ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡, titleê³¼ content ë‘ê°€ì§€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìˆë„ë¡)

> íƒœê³¤ë‹˜ í¬ìŠ¤íŠ¸ëŠ” ê¼­ ì½ì–´ë³´ì„¸ìš”! ê°„ë‹¨í•˜ë©´ì„œë„ í¥ë¯¸ë¡­ë”ë¼ê³ ìš”ğŸ˜ ë‹¤ë§Œ ë§ˆì§€ë§‰ì— `longestDistance`ê°€ ê¸´ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ëŠ”ê²ƒì´ ì¢‹ì€ ë°˜ì‘ì„ ì–»ì—ˆë‹¤ëŠ” ì˜ê²¬ì„ ì†Œê°œí•´ì£¼ì…¨ëŠ”ë°, ì™œ ê·¸ëŸ°ì§€ ê¶ê¸ˆí•˜ê¸´ í–ˆìŠµë‹ˆë‹¤. ì €ëŠ” ì§§ì€ ìˆœìœ¼ë¡œ ì“°ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” ì œê°€ ìˆ˜ì •í•œ ì½”ë“œì…ë‹ˆë‹¤.

```ts
// utils/fuzzy.ts

// íƒœê³¤ë‹˜ì˜ createFuzzyMatcher()
const regex = createFuzzyMatcher(query);

const findFuzzyPostData = (
  option: "title" | "content",
  regex: RegExp
) => {
  let results = [];
  for (const postData of CacheDB) {
    const match = postData[option].match(regex);

    if (
      !match ||
      match.index === undefined ||
      match[0].length > 50
    ) {
      continue;
    }

    const index = match.index;

    results.push({
      ...postData,
      [option]: [
        postData[option].slice(0, index),
        match[0],
        postData[option].slice(index + match[0].length),
      ],
      matchLength: match[0].length,
      matchedOne: option,
    });
  }

  return results;
};

export default function getFuzzyPostData(query: string) {
  const regex = createFuzzyMatcher(query);
  const result = [
    ...findFuzzyPostData("title", regex),
    ...findFuzzyPostData("content", regex),
  ].sort(
    (post1, post2) => post2.matchLength - post1.matchLength
  );

  return result;
}
```

í”„ë¡ íŠ¸ì—”ë“œë‹¨ì—ì„œ `match`ëœ `string`ì— ë”°ë¡œ ìŠ¤íƒ€ì¼ì„ ì¤„ ìˆ˜ ìˆë„ë¡ ë°°ì—´ë¡œ ë¶„ë¦¬í•˜ê³ , ì–´ëŠ ë¶€ë¶„ì´ `match`ëœê±´ì§€ë¥¼ ì•Œë¦¬ëŠ” `matchedOne` í”„ë¡œí¼í‹°ë¥¼ ë„£ì—ˆìŠµë‹ˆë‹¤. íƒœê³¤ë‹˜ì˜ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì ìš©í•˜ë©´ `longestDistance`ì— ì œí•œì´ ì—†ì–´ `content`ê°™ì´ ê¸´ ë¬¸êµ¬ì—ì„œëŠ” ì•„ì£¼ ê¸¸ê²Œë„ `match`ë¥¼ ì°¾ëŠ” ì´ìŠˆê°€ ë°œìƒí•´ í•´ë‹¹ ë¶€ë¶„ë„ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

### ì—”ë“œí¬ì¸íŠ¸

ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ë¶€ë¶„ì€ `fuzzy.ts`ì—ì„œ ëª¨ë“  ë¡œì§ì„ ìˆ˜í–‰í•˜ê³  ìˆì–´ ë§¤ìš° ê°„ë‹¨í–ˆìŠµë‹ˆë‹¤.

```ts
export default async function searchAPI(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const { q } = req.query;

  if (req.method !== "GET" || typeof q !== "string") {
    return res
      .status(400)
      .json({ message: "ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤." });
  }
  console.log(q);

  const results = q ? getFuzzyPostData(q) : [];

  return res
    .status(200)
    .setHeader("Content-Type", "application/json")
    .json(results);
}
```

- [API ë°ëª¨ (query = "next")](https://custardcream.vercel.app/api/search?q=next)

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„  ì´ë ‡ê²Œ ê°œë°œí•œ APIë¥¼ í™œìš©í•´ ì‹¤ì œ ë¸”ë¡œê·¸ì— ì ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.
